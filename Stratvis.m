clear all;
close all;
clc

scrn_size = get(0, 'ScreenSize');

f = figure('Name', 'StratVis', ...
    'Visible', 'on', ...
    'Position', [0,0,scrn_size(3),scrn_size(4)], ...
    'NumberTitle', 'Off', ...
    'MenuBar', 'none', ...
    'resize', 'off'...
    );

%---------------------------------------------------------------------------------------------------------------------
%----------------------------------------------Panel de chargement----------------------------------------------------
%---------------------------------------------------------------------------------------------------------------------

chargement = uipanel( ...
    'Parent', f, ...
    'Title', 'Chargement des données', ...
    'Units', 'Pixels', ...
    'FontSize', 10, ...
    'Position', [50, 520, 400, 200 ] ...
    );

load_button1 = uicontrol('Parent', chargement, ...
    'Style', 'pushbutton', ...
    'FontSize', 10, ...
    'String', 'Coordonnées Marqueur', ...
    'Tag','Load_button1',...
    'Position', [20, 130, 200, 30], ...
    'callback', {@load1_callback}...
    );

load_button2 = uicontrol('Parent', chargement, ...
    'Style', 'pushbutton', ...
    'FontSize', 10, ...
    'String', 'Coordonnées Masques', ...
    'Tag','Load_button2',...
    'Position', [20, 90, 200, 30], ...
    'callback', {@load2_callback}...
    );

load_button3 = uicontrol('Parent', chargement, ...
    'Style', 'pushbutton', ...
    'FontSize', 10, ...
    'String', 'Vidéo', ...
    'Tag','Load_button3',...
    'Position', [20, 50, 200, 30],...
    'callback', {@load3_callback}...
    );

validation_button = uicontrol('Parent', chargement, ...
    'Style', 'pushbutton', ...
    'FontSize', 10, ...
    'String', 'Valider', ...
    'Position', [250, 90, 120, 30], ...
    'callback', {@validation_callback}...
    );


%---------------------------------------------------------------------------------------------------------------------
%----------------------------------------------PanelVidéo-------------------------------------------------------------
%---------------------------------------------------------------------------------------------------------------------
v = uipanel( ...
    'Parent', f, ...
    'Title', 'Chargement des données', ...
    'Units', 'Pixels', ...
    'FontSize', 10, ...
    'Position', [500, 400, 800, 320 ] ...
    );

handles.movie_scrn = axes( ...
    'Parent', v, ...
    'tag', 'movie_scrn', ...
    'Units', 'Pixels', ...
    'YTick', [], ...
    'XTick', [], ...
    'NextPlot', 'add', ...
    'Position', [20, 10, 380, 340] ...
    );

movie_slider = uicontrol( ...
    'Parent', v, ...
    'Style', 'slider', ...
    'String', 'test', ...
    'Position', [450, 20, 220, 20], ...
    'SliderStep', [.001, .01]...
    );

play_stop_button = uicontrol( ...
    'Parent', v, ...
    'Style', 'pushbutton', ...
    'FontSize', 10, ...
    'String', 'Play', ...
    'Position', [450, 180, 60, 25],...
    'callback', {@play_Callback} ...
    );

uicontrol( ...
    'Parent', v, ...
    'Style', 'text', ...
    'HorizontalAlignment', 'left', ...
    'FontSize', 10, ...
    'String', 'Debut (sec) :', ...
    'Position', [450, 110, 105, 15] ...
    );

starttimemap_edit = uicontrol( ...
    'Parent', v, ...
    'Style', 'edit', ...
    'FontSize', 10, ...
    'Position', [580, 110, 60, 20]...
    );

% endtimemap_text =
uicontrol( ...
    'Parent', v, ...
    'Style', 'text', ...
    'HorizontalAlignment', 'left', ...
    'FontSize', 10, ...
    'String', 'Fin (sec) :', ...
    'Position', [450, 80, 105, 15] ...
    );

endtimemap_edit = uicontrol( ...
    'Parent', v, ...
    'Style', 'edit', ...
    'FontSize', 10, ...
    'Position', [580, 80, 60, 20]...
    );
%---------------------------------------------------------------------------------------------------------------------
%----------------------------------------------Tableau--------------------------------------------------------------
%---------------------------------------------------------------------------------------------------------------------
tab = uitable(...
    'Parent',f,...
    'Data',randi(100,10,3),...
    'Position',[50 20 1250 350]...
    );
tab.ColumnName = {'ROI','fixation time','orde de decouverte'};
tab.ColumnEditable = true;
%---------------------------------------------------------------------------------------------------------------------
%----------------------------------------------Variables--------------------------------------------------------------
%---------------------------------------------------------------------------------------------------------------------
handles.filename1=0;
handles.filename2=0;
handles.filename3=0;
%---------------------------------------------------------------------------------------------------------------------
%----------------------------------------------Callbacks--------------------------------------------------------------
%---------------------------------------------------------------------------------------------------------------------

function load1_callback (hObject,~)
[FileName,PathName,FilterIndex] = uigetfile('*.txt', 'Selectionner le fichier texte avec les coordonnées du marqueur');
disp(hObject.String)
handles = guihandles(hObject);
handles.Load_button1.String = FileName;
handles.marqueur = importdata(FileName);
handles.filename1=FileName;
guidata(hObject, handles);
end

function load2_callback (hObject,~)
[FileName,PathName,FilterIndex] = uigetfile('*.txt', 'Selectionner le fichier texte avec les coordonnées des masques');
disp(hObject.String)
handles = guihandles(hObject);
handles.Load_button2.String = FileName;
handles.masque = importdata(FileName);
handles.filename2=FileName;
guidata(hObject, handles);
end

function load3_callback (hObject,~)
[FileName,PathName,FilterIndex] = uigetfile('*.avi', 'Selectionner la vidéo')
disp(hObject.String)
handles = guihandles(hObject);
handles.Load_button3.String = FileName;
handles.filename3=FileName;
guidata(hObject, handles);
end

function validation_callback(hObject,~)
end

function play_Callback(hObject,~)
handles = guidata(hObject);
handles.nom=handles.filename3;

try
    % Check the status of play button
    isTextStart = strcmp(hObject.String,'Play');
    isTextCont  = strcmp(hObject.String,'Stop');
    if isTextStart
        % Two cases: (1) starting first time, or (2) restarting
        % Start from first frame
        if isDone(videoSrc)
            reset(videoSrc);
        end
    end
    if (isTextStart || isTextCont)
        hObject.String = 'Play';
    else
        hObject.String = 'Stop';
    end
    
    % frames on figure
    angle = 0;
    while strcmp(hObject.String, 'Pause') && ~isDone(videoSrc)
        % Get input video frame and rotated frame
        [frame,angle] = getAndProcessFrame(videoSrc,angle);
        % Display input video frame on axis
        showFrameOnAxis(movie_scrn_1, frame);
        
    end
    
    % When video reaches the end of file, display "Start" on the
    % play button.
    if isDone(videoSrc)
        hObject.String = 'Start';
    end
catch ME
    % Re-throw error message if it is not related to invalid handle
    if ~strcmp(ME.identifier, 'MATLAB:class:InvalidHandle')
        rethrow(ME);
    end
end
end